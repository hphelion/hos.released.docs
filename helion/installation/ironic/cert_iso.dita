<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="cert-iso">
    <title>Adding a certificate into an ISO image</title>
    
    <body>
    <p>

As root, proceed with the following steps to disassemble the ISO image, and insert a new Certificate Authority or Signing Certificate into the provided image.
1.Download the deployment ISO image from glance and place it in /tmp/ as ironic-deploy.iso.
2.Make a temporary folder to mount the ironic-deploy.iso image to in order to extract it’s contents.

mkdir /mnt/deploy_iso


3.Mount the ironic-deploy.iso image file to a the folder you just create.

mount -o loop /tmp/ironic-deploy.iso /mnt/deploy_iso/


4.Make a temporary location to stage the new image.

mkdir /tmp/new_deploy_iso


5.Copy the contents from the previous image into the new temporary staging location.

cp -ra /mnt/deploy_iso/. /tmp/new_deploy_iso/


6.Make a folder to house the ramdisk that will need to be extracted from the ISO image.

mkdir /tmp/new_deploy_ramdisk


7.Change your working directory to /tmp/new_deploy_ramdisk

cd /tmp/new_deploy_ramdisk


8.Unpack the ramdisk image.

zcat /tmp/new_deploy_iso/initrd | cpio --extract --make-directories


9.Append your CA certificate to the file located at "/tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem", example below:

cat your_ca_certificate.pem >> /tmp/new_deploy_ramdisk/usr/local/lib/python2.7/dist-packages/requests/cacert.pem


10.Replace the pre-existing initial ramdisk in the extracted disk image.

find . | cpio --create --format='newc' | gzip -c -9 > /tmp/new_deploy_iso/initrd


11.Change directory back to the new deployment ISO image folder.

cd /tmp/new_deploy_iso


12.Ensure that the program “xorriso” is available, you may need to execute `apt-get install xorriso` to install it.
13.Create the new ISO deployment image utilizing the following command.

xorriso -as mkisofs -b isolinux/isolinux.bin -c boot.cat -V VMEDIA_BOOT_ISO -r -J -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot --efi-boot boot/grub/efi.img -isohybrid-gpt-basdat -isohybrid-apm-hfsplus -o /tmp/new_ironic_deploy.iso ./

Once completed, the new image can be found at /tmp/new_ironic_deploy.iso, and will need to be uploaded to glance. New glance IDs will need to be recorded for any instances requiring this new image, as noted in the parent paragraph



    </p>
    </body>
</topic>

