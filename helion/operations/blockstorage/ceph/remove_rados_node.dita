<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="remove_monitor_node">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Removing a Ceph RADOS Gateway Node</title>
  <abstract>
    <shortdesc outputclass="hdphidden">Steps for removing Ceph RADOS Gateway nodes.</shortdesc>
  </abstract>
  <body>
    <!--not tested-->
    <p conkeyref="HOS-conrefs/applies-to"/>
    <section id="notes">
      <title>Notes</title>
      <p>Removal of Rados Gateway Node is only supported when it is installed on a dedicated cluster
        node. </p>
      <ul id="ul_fwh_gdj_yv">
        <li>On (dedicated) cluster node(s) that host Ceph Monitor service. Rados Gateway alone
          cannot be removed permanently. Both Rados Gateway and Monitor can be removed by following
          the procedure to remove the Ceph Monitor node</li>
        <li>On controller nodes. the removal of Rados Gateway is not supported. </li>
      </ul>
      <note>For HA of Rados Gateway service, it is recommended to have atleast 2 Rados Gateway
        servers in your deployment. </note>
    </section>
    <section id="remove_ceph_monitor"><title>To removal a RADOS Gateway installed on a dedicated
        cluster node</title>Perform the following steps to remove a monitor node from a
      separate/dedicated node. <ol id="ol_bbd_vdj_yv">
        <li>Login to the lifecycle manager. </li>
        <li>Execute the following command for the RADOS gateway
          node:<codeblock>cd ~/scratch/ansible/next/hos/ansible ansible-playbook -i hosts/verb_hosts hlm-stop.yml --limit &lt;node-name></codeblock>
          For example:
          <codeblock>cd ~/scratch/ansible/next/hos/ansible ansible-playbook -i hosts/verb_hosts hlm-stop.yml --limit helion-cp1-rgw-m1-mgmt</codeblock></li>
        <li>Edit the input model to remove the section corresponding to the RADOS Gateway server.
          The input model is in the <codeph>~/helion/my_cloud/definition/data/servers.yml</codeph>
          file.</li>
        <li>Commit your configuration:
            <codeblock>cd ~/helion/hos/ansible git add -A git commit -m "Removed Rados Gateway node &lt;host-name>"</codeblock><note>Replace
            the string &lt;host-name> in the above commit message with the actual host
          name.</note></li>
        <li>Run the configuration processor:
          <codeblock>cd ~/helion/hos/ansible 
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock></li>
        <li>Use the playbook below to create a deployment directory:
          <codeblock>cd ~/helion/hos/ansible 
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock></li>
        <li>Remove the OSD host from Cobbler:
          <codeblock>sudo cobbler system remove --name &lt;node-name> </codeblock>For example:
            <codeblock>sudo cobbler system remove --name rgw1</codeblock><note>If you need to
            determine the OSD hostname in Cobbler you can use:
            <codeblock>sudo cobbler system list</codeblock></note></li>
        <li>Run <codeph>site.yml</codeph> to notify other services:
          <codeblock>cd ~/scratch/ansible/next/hos/ansible 
ansible-playbook -i hosts/verb_hosts site.yml </codeblock></li>
      </ol></section>
    
    <section><title>Removing the Node from Monitoring</title>Once you have removed the Ceph Rados
      Gateway node, the alarms against them will trigger so there are additional steps to take to
      resolve this issue. </section>
    <section>SSH into each of the Monasca API servers and edit the
        <codeph>/etc/monasca/agent/conf.d/host_alive.yaml</codeph> file to remove references to the
      Ceph Rados Gateway node you removed. This will require sudo access. <p>Once you have removed
        the references on each of your Monasca API servers you then need to restart the Monasca
        Agent on each of those servers with this command:
      </p><codeblock>sudo service monasca-agent restart</codeblock>With the Ceph Rados Gateway node
      references removed and the Monasca Agent restarted, you can then delete the corresponding
      alarm to finish this process. To do so we recommend using the Monasca CLI which should be
      installed on each of your Monasca API servers by default:
      <codeblock>monasca alarm-list --metric-name host_alive_status --metric-dimensions hostname=&lt;ceph rados gateway node deleted></codeblock>
      You can then delete the alarm with this command:
      <codeblock>monasca alarm-delete &lt;alarm ID></codeblock>
    </section>
  </body>
</topic>
