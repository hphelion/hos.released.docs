<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="remove_monitor_node">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Removing a Ceph RADOS Gateway Node</title>
  <abstract><shortdesc outputclass="hdphidden">Steps for removing Ceph monitor nodes.</shortdesc>The
    process to remove Ceph monitor nodes, depends on how they have been deployed - either on the
    controller node or on a separate/dedicated resource node.</abstract>
  <body>
    <!--not tested-->
    <p conkeyref="HOS-conrefs/applies-to"/>

    <section id="notes">
      <title>Notes</title>
      <p>Removal of Rados Gateway Node is only supported when it is installed on a dedicated cluster
        node. </p>
      <ul id="ul_fwh_gdj_yv">
        <li>On (dedicated) cluster node(s) that host Ceph Monitor service.  Rados Gateway alone
          cannot be removed permanently. Both Rados Gateway and Monitor can be removed by following
          the procedure to remove the Ceph Monitor node</li>
        <li>On controller nodes. the removal of Rados Gateway is not supported. </li>
      </ul>
      <note>For HA of Rados Gateway service, it is recommended to have atleast 2 Rados Gateway
        servers in your deployment. </note>
    </section>

    <section id="remove_ceph_monitor"><title>To removal a RADOS Gateway installed on a dedicated
        cluster node</title>Perform the following steps to remove a monitor node from a
      separate/dedicated node. <ol id="ol_bbd_vdj_yv">
        <li>Login to the lifecycle manager. </li>
        <li>Execute the following command for the RADOS gateway
          node:<codeblock>cd ~/scratch/ansible/next/hos/ansible ansible-playbook -i hosts/verb_hosts hlm-stop.yml --limit &lt;node-name></codeblock>
          For example:
          <codeblock>cd ~/scratch/ansible/next/hos/ansible ansible-playbook -i hosts/verb_hosts hlm-stop.yml --limit helion-cp1-rgw-m1-mgmt</codeblock></li>
        <li>Edit the input model to remove the section corresponding to the RADOS Gateway server.
          The input model is in the <codeph>~/helion/my_cloud/definition/data/servers.yml</codeph>
          file.</li>
        <li>Commit your configuration: cd ~/helion/hos/ansible git add -A git commit -m "Removed
          Rados Gateway node &lt;host-name>" Note: Replace the string &lt;host-name> in the above
          commit message with the actual host name. 4. Run the configuration processor: cd
          ~/helion/hos/ansible ansible-playbook -i hosts/localhost config-processor-run.yml 5. Use
          the playbook below to create a deployment directory: cd ~/helion/hos/ansible
          ansible-playbook -i hosts/localhost ready-deployment.yml 6.Remove the OSD host from
          Cobbler: sudo cobbler system remove --name &lt;node-name> Example: sudo cobbler system
          remove --name rgw1 Note: If you need to determine the OSD hostname in Cobbler you can use
          sudo cobbler system list 7.Run site.yml to notify other services: cd
          ~/scratch/ansible/next/hos/ansible ansible-playbook -i hosts/verb_hosts site.yml </li>
      </ol></section>
    <section id="remove-monitor-separate">
      <title>Remove Monitor Nodes from a Separate/Dedicated Node</title>
      <p>Perform the following steps to remove a monitor node from a separate/dedicated node.</p>
      <ol>
        <li>Login to the monitor node to be removed.</li>
        <li>Stop the monitor service running on the specific host by running the following commands
          :<codeblock>service ceph-mon@&lt;ceph-mon-host> stop</codeblock></li>
        <li>Remove the monitor
          service:<codeblock>ceph mon remove &lt;ceph-mon-host></codeblock></li>
        <li>Login to the lifecycle manager.</li>
        <li>Edit the <codeph>servers.yml</codeph> file and remove the host section from the
          file.<codeblock>vim  ~/helion/my_cloud/definition/data/servers.yml</codeblock></li>
        <li>Commit your configuration to the <xref href="../../../installation/using_git.dita">local
            git repo</xref>, as follows:
          <codeblock>cd ~/helion/hos/ansible
git add -A
git commit -m "My config or other commit message"</codeblock></li>
        <li>Run the configuration processor:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost config-processor-run.yml</codeblock></li>
        <li>Update your deployment directory:
          <codeblock>cd ~/helion/hos/ansible
ansible-playbook -i hosts/localhost ready-deployment.yml</codeblock></li>
      </ol>
    </section>
    <section id="monitoring"><title>Removing the Node from Monitoring</title>
      <p>Once you have removed the Ceph Monitor node, the alarms against them will trigger so there
        are additional steps to take to resolve this issue.</p>
      <p>You will want to SSH to each of the Monasca API servers and edit the
          <codeph>/etc/monasca/agent/conf.d/host_alive.yaml</codeph> file to remove references to
        the Ceph Monitor node you removed. This will require <codeph>sudo</codeph> access.</p>
      <p>Once you have removed the references on each of your Monasca API servers you then need to
        restart the monasca-agent on each of those servers with this command:</p>
      <codeblock>sudo service monasca-agent restart</codeblock>
      <p>With the Ceph Monitor node references removed and the monasca-agent restarted, you can then
        delete the corresponding alarm to finish this process. To do so we recommend using the
        Monasca CLI which should be installed on each of your Monasca API servers by default:</p>
      <codeblock>monasca alarm-list --metric-name host_alive_status --metric-dimensions hostname=&#60;ceph monitor node deleted></codeblock>
      <p>You can then delete the alarm with this command:</p>
      <codeblock>monasca alarm-delete &#60;alarm ID></codeblock>
    </section>
  </body>
</topic>
